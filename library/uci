#!/usr/bin/lua
--
-- Ansible module for LUCI
--

require("uci")
x = uci.cursor()

command = os.getenv("command")
key     = os.getenv("key")
value   = os.getenv("value")

fail = function (msg)
  print('{"failed": true, "msg": "' .. msg .. '"}')
  os.exit(1)
end

if not key then
  fail("key is missing")
end

if not value then
  fail("value is missing")
end

-- split key
config, section, option = string.match(key, "([^\.]+)\.([^\.]+)\.([^\.]+)")

if command=="set" then
  old = x:get(config, section, option)
  if old == value then
    print('{"changed": false}')
  else
    if not x:get(config, section) then
      fail("section not found")
    end

    x:set(config, section, option, value)
    x:commit(config)
    print('{"changed": true}')
  end
else
  fail("unsupported command: " .. command)
end
