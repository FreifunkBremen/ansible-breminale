#!/usr/bin/lua
--
-- Ansible module for LUCI
--

require("uci")
x = uci.cursor()

command = os.getenv("command")
key     = os.getenv("key")
value   = os.getenv("value")

if not key then
  print("key is nil")
  os.exit(1)
end

if not value then
  print("value is nil")
  os.exit(1)
end

-- split key
config, section, option = string.match(key, "([^\.]+)\.([^\.]+)\.([^\.]+)")

if command=="set" then
  if old == value then
    print('{"changed": false}')
  else
    if not x:get(config, section) then
      print('{"failed": true, "msg": "section not found"}')
      os.exit(2)
    end

    x:set(config, section, option, value)
    x:commit(config)
    print('{"changed": true}')
  end
else
  print('{"failed": true, "msg": "unsupported command: ' + command + '"}')
end
